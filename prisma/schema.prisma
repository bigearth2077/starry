generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SessionStatus {
  PLANNED
  CANCELED
  DONE
}

model Teacher {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String?
  passwordHash String // ← 新增：登录用的哈希

  semesters Semester[]
  classes   Class[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Semester {
  id        String  @id @default(cuid())
  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  name      String

  // 不再直接存起止/费用；通过 ClassTerm 聚合出视图
  classTerms ClassTerm[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, name]) // 老师下学期名去重（可选）
}

model Class {
  id        String  @id @default(cuid())
  teacherId String
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  name      String

  classTerms ClassTerm[] // ← 必须存在（班级-学期 关系）
  students   Student[] // ← 新增：班级下的学生列表

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, name])
}

model Student {
  id String @id @default(cuid())

  // 学生隶属班级（你之前的需求）
  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  name  String
  phone String?
  note  String?

  enrollments Enrollment[]
  absences    Absence[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // 同一个班里不允许重名
  @@unique([classId, name])
}

model ClassTerm {
  id         String   @id @default(cuid())
  classId    String
  semesterId String
  class      Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  semester   Semester @relation(fields: [semesterId], references: [id], onDelete: Cascade)

  // 该班级在该学期内的具体安排与费用
  startDate     DateTime
  endDate       DateTime
  weekdays      Int[] // 0..6，上课周几
  perSessionFee Decimal  @db.Decimal(10, 2)
  currency      String   @default("CNY")

  sessions    ClassSession[]
  enrollments Enrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, semesterId, startDate, endDate], name: "class_sem_term_span") // 可选防重复
}

model ClassSession {
  id          String        @id @default(cuid())
  classTermId String
  classTerm   ClassTerm     @relation(fields: [classTermId], references: [id], onDelete: Cascade)
  date        DateTime
  status      SessionStatus @default(PLANNED)
  absences    Absence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classTermId, date], name: "classTermId_date")
}

model Enrollment {
  id          String    @id @default(cuid())
  studentId   String
  classTermId String
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classTerm   ClassTerm @relation(fields: [classTermId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classTermId])
}

model Absence {
  id        String       @id @default(cuid())
  sessionId String
  session   ClassSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentId String
  student   Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  reason    String?
  createdAt DateTime     @default(now())

  @@unique([sessionId, studentId], name: "sessionId_studentId")
}
